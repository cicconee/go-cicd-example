# Example GO CICD Application
An example Go application that uses github actions to deploy code commits. 

## Required
- DigitalOcean account
- Github account

## Technologies
- Go 1.19
- DigitalOcean Droplet (Ubuntu 22.04)
- Github Actions

## Configuring CI/CD

This section documents the steps needed to configure the CI/CD pipeline using Github Actions and DigitalOcean Droplets. 

## Generating SSH Keys

Configuring the CI/CD pipeline will require the use of two seperate SSH keys. The first key will be for the root user. This key is very important as gaining access to this key will give root access to the server. The second key is for the Github Actions deployer. This key will be for a user with limited access.

Generate the root key. It is highly recommended to password protect your SSH keys.

```sh
ssh-keygen
```

You will be prompted to save and name the key. I like to name my keys by service (and role if it applies).

```
Generating public/private rsa key pair. Enter file in which to save the key (/Users/USER/.ssh/id_rsa): /Users/USER/.ssh/digitalocean
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
```

This will generate two files `digitalocean` and `digitalocean.pub`.

Repeat this process for the second key but use `digitalocean_deployer` for the key file name.

## DigitalOcean

Go to DigitalOcean and create a new project. Give it a meaningful name and description. Once the project is created, create a new Ubuntu 22.04 (LTS) Droplet. When prompted to choose your authentication method select `SSH Key` and choose `New SSH Key`. Give this key a name and paste the contents of `~/.ssh/digitalocean.pub`.

```sh
cat ~/.ssh/digitalocean.pub
``` 

Add the SSH key and make sure it is selected before creating the droplet. **Do not set up the other key yet.**

Lastly, select the project you just created.

Once it is created the IP address should be displayed near the droplet name. In a terminal try to login to the server.

```sh
ssh -i ~/.ssh/digitalocean root@<ip-address>
```

Enter your password if you used one when creating the key.


### Systemd

In a SSH session logged in as root, configure a systemd unit file to run the application as a system service. Use your favorite text editor (I use nano) and create a new systemd file. 

```sh
nano /etc/systemd/system/<service-name>.service
``` 

Paste the following content.

```
[Unit]
Description=Your service description

[Service]
Type=simple
Restart=always
RestartSec=3
ExecStart=/home/deployer/<APP-FOLDER>
RemainAfterExit=yes
StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=<APP-IDENTIFIER>
EnvironmentFile=/home/deployer/<APP-FOLDER>/.env

[Install]
WantedBy=multi-user.target
```

Besure to change `ExecStart`, `EnvironmentFile`, and `SyslogIdentifier` with your own system configurations.

All environment variables required by the service will be set in the file used by `EnvironmentFile`. This file will be generated by a Github Action.

Now you can enable the service to start at boot time.

```shell
systemctl enable <service-name>
```

### Create Deployer User

The user `deployer` will be the user that Github Actions uses to SSH into the droplet.

Log in to the droplet as `root` and create the user with a home directory.

```sh
useradd -m deployer
```

Set the password of `deployer`. 

```sh
passwd deployer
```

Input the password as prompted.

### Give Systemctl Restart Privilege to Deployer

`deployer` will be used by Github Actions to SSH into the droplet and restart the service after copying the new binary. This is a very specific privilege `deployer` requires. A perfect reason to make use of the `sudoers` file. 

As `root` open the `/etc/sudoers` file.

```sh
nano /etc/sudoers
```

Add the line in `User privilege specification` section below the `root` definition:

```
deployer    ALL = NOPASSWD: /usr/bin/systemctl restart <service>
```

This will allow `deployer` to run `sudo systemctl restart <service-name>` without needing to provide a password.

### Adding Deployer SSH Key

On the local machine that generated the key `digitalocean_deployer`, print the public key and copy the output.

```sh
cat ~/.ssh/digitalocean_deployer.pub
```

SSH into the droplet as root and create the `/home/deployer/.ssh` directory if it does not already exist.

```sh
mkdir -p /home/deployer/.ssh
```

Add the SSH key to an `authorized_keys` file in this directory.

```sh
nano /home/deployer/.ssh/authorized_keys
```

Paste the key to the file and save.

The `/home/deployer/.ssh` directory and `/home/deployer/.ssh/authorized_keys` file must have specific restricted permissions (`700` for `.ssh` and `600` for `authorized_keys`). If they don't, you won't be able to log in.

```sh
chmod -R go= /home/deployer/.ssh
chown -R deployer:deployer /home/deployer/.ssh
```

Now it is possible to SSH into the droplet logging in as `deployer`.

```sh
ssh -i ~/.ssh/digitalocean_deployer deployer@<ip-address>
```